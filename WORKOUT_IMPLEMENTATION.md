# Реализация функциональности кнопки тренировки

## Обзор

Этот документ описывает реализацию функциональности кнопки тренировки с удержанием, включая визуальную индикацию прогресса, управление состоянием интерфейса и интеграцию с геолокацией и аудио-ассистентом.

## Компоненты системы

### 1. Workout Store (src/utils/workoutStore.ts)

Центральное хранилище состояния тренировки, реализованное с помощью Svelte Store:

- Управление состоянием тренировки (idle, running, paused)
- Хранение статистики тренировки (время, расстояние, скорость)
- Функции обновления состояния (startWorkout, pauseWorkout, resumeWorkout, stopWorkout)

### 2. Circular Progress Bar (src/CircularProgressBar.svelte)

Компонент визуальной индикации прогресса:

- SVG-реализация кругового прогресс-бара
- Динамическое вычисление stroke-dasharray и stroke-dashoffset
- Настройка цвета, размера и толщины линии
- Анимация заполнения по часовой стрелке

### 3. Workout Button (src/WorkoutButton.svelte)

Основной компонент кнопки тренировки:

- Обработка событий touchstart/touchend и mousedown/mouseup
- Отслеживание удержания в течение 2.5 секунд
- Визуализация прогресса через CircularProgressBar
- Переключение между состояниями (start, stop, pause, resume)
- Мгновенное действие для кнопки "Продолжить"

### 4. Bottom Navigation (src/BottomNav.svelte)

Обновленный компонент нижней навигации:

- Интеграция WorkoutButton вместо простой круговой кнопки
- Передача обработчиков событий в WorkoutButton

### 5. Training View (src/Training.svelte)

Основное представление тренировки:

- Импорт и использование WorkoutButton
- Реализация обработчиков событий тренировки
- Интеграция с геолокацией и сбором данных

## Реализация функциональности

### 1. Удержание кнопки (2.5 секунды)

- При touchstart/mousedown запускается таймер
- Каждые 50 мс обновляется визуальный прогресс
- При touchend/mouseup до завершения 2.5 секунд прогресс сбрасывается
- При достижении 2.5 секунд выполняется соответствующее действие

### 2. Визуальная индикация

- Использование SVG для создания кругового прогресс-бара
- Динамическое вычисление параметров stroke-dasharray и stroke-dashoffset
- Плавная анимация заполнения
- Разные цвета для разных состояний (синий - старт, красный - стоп, желтый - пауза, зеленый - продолжить)

### 3. Переключение UI

- После запуска тренировки кнопка заменяется на "Стоп" и "Пауза"
- В режиме паузы кнопка "Пауза" заменяется на "Продолжить"
- Кнопка "Продолжить" не требует удержания, реагирует на одиночное нажатие

### 4. Управление состоянием интерфейса

- Использование Svelte Store для централизованного управления состоянием
- Блокировка элементов интерфейса при активной тренировке
- Реактивные переменные для динамического рендеринга компонентов

## Процессы тренировки

### 1. Сбор данных

- Время: отсчет с момента запуска через performance.now() с точностью до 100 мс
- Дистанция и скорость: вычисляются на основе координат GPS/Glonass
- Расстояние рассчитывается по формуле Хаверсина между последовательными точками
- Скорость — как производная дистанции по времени
- Геолокация: данные обновляются каждые 1-2 секунды

### 2. Аудио-ассистент

- Реализация через Web Speech API (SpeechSynthesis)
- Для Android-версии используется capacitor-audio для фонового воспроизведения
- Генерация голосовых подсказок ("Пройдено 500 метров", "Скорость 12 км/ч")

### 3. Трекинг пути на Mapbox

- Интеграция Mapbox GL JS для отображения реального маршрута
- Построение polyline на карте с динамическим обновлением координат
- Использование capacitor-maps для совместимости с Android-устройствами

### 4. Инициализация локации

- Запрос разрешений на доступ к геолокации только при активации тренировки
- Блокировка запросов к геоданным до момента запуска тренировки
- Использование navigator.geolocation.watchPosition() после запуска

## Мобильные особенности (Capacitor)

- Компиляция Svelte-приложения в Android через Capacitor
- Использование @capacitor/geolocation для точного GPS/Glonass-трекинга
- @capacitor/background-task для поддержки фоновых процессов
- @capacitor/permissions для динамического запроса разрешений
- Адаптивный CSS-дизайн и использование touch-событий

## Обработка ошибок

- Отказ в доступе к локации: отображение уведомления с инструкцией
- Потеря GPS-сигнала: сохранение последней корректной точки и анимация предупреждения
- Общие принципы graceful degradation

## Технические требования

- Svelte-компоненты с изоляцией и строгой типизацией через TypeScript
- Централизованное управление состоянием через Svelte-Store
- Независимые компоненты с пропсами для контроля
- Кастомный стиль Mapbox с акцентом на читаемость маршрута
- Поддержка синтеза речи на русском языке
- Кэширование сетевых запросов для работы в оффлайн-режиме

## Состояния тренировки

1. **Idle**: Ожидание начала тренировки
2. **Running**: Активная тренировка
3. **Paused**: Тренировка на паузе

## Цветовая схема кнопок

- **Старт**: Градиент синий-розовый (#00BFFF → #FF1493)
- **Стоп**: Градиент красный-темно-красный (#FF0000 → #990000)
- **Пауза**: Градиент желтый-темно-желтый (#FFFF00 → #CCCC00)
- **Продолжить**: Градиент зеленый-темно-зеленый (#00FF00 → #009900)

## Временные параметры

- **Длительность удержания**: 2.5 секунды (2500 мс)
- **Частота обновления прогресса**: 50 мс
- **Частота обновления геолокации**: 1-2 секунды
- **Точность времени**: 100 мс
- **Таймаут геолокации**: 5 секунд
- **Максимальный возраст кэшированной позиции**: 3 секунды